<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Results Sheet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./styles.css" />
  <style>@media print{.noprint{display:none}}</style>
</head>
<body>
  <header>
    <h1>Results Sheet</h1>
    <button class="noprint" onclick="window.print()">Print</button>
  </header>

  <section class="stats">
    <div><strong>Student:</strong> <span id="pStudent">—</span></div>
    <div><strong>Scale:</strong> <span id="pScale">—</span></div>
    <div><strong>Total Units:</strong> <span id="pUnits">0</span></div>
    <div><strong>GPA:</strong> <span id="pGpa">0.00</span></div>
  </section>

  <table class="grid">
    <thead>
      <tr>
        <th>Course</th><th>Units</th><th>Score</th><th>Grade</th><th>Points</th>
      </tr>
    </thead>
    <tbody id="pBody"></tbody>
  </table>

<script>
const SCALES = {
  nigeria:[{letter:'A',min:70,points:5},{letter:'B',min:60,points:4},{letter:'C',min:50,points:3},{letter:'D',min:45,points:2},{letter:'E',min:40,points:1},{letter:'F',min:0,points:0}],
  us:[{letter:'A',min:90,points:4},{letter:'B',min:80,points:3},{letter:'C',min:70,points:2},{letter:'D',min:60,points:1},{letter:'F',min:0,points:0}],
  us_plusminus:[{letter:'A+',min:97,points:4.3},{letter:'A',min:93,points:4.0},{letter:'A-',min:90,points:3.7},{letter:'B+',min:87,points:3.3},{letter:'B',min:83,points:3.0},{letter:'B-',min:80,points:2.7},{letter:'C+',min:77,points:2.3},{letter:'C',min:73,points:2.0},{letter:'C-',min:70,points:1.7},{letter:'D',min:60,points:1.0},{letter:'F',min:0,points:0}],
  canada:[{letter:'A',min:85,points:4},{letter:'B',min:70,points:3},{letter:'C',min:60,points:2},{letter:'D',min:50,points:1},{letter:'F',min:0,points:0}],
  uk:[{letter:'First',min:70,points:4},{letter:'Upper Second',min:60,points:3},{letter:'Lower Second',min:50,points:2},{letter:'Third',min:40,points:1},{letter:'Fail',min:0,points:0}],
  australia:[{letter:'HD',min:85,points:7},{letter:'D',min:75,points:6},{letter:'C',min:65,points:5},{letter:'P',min:50,points:4},{letter:'N',min:0,points:0}],
  india:[{letter:'O',min:90,points:10},{letter:'A+',min:80,points:9},{letter:'A',min:70,points:8},{letter:'B+',min:60,points:7},{letter:'B',min:55,points:6},{letter:'C',min:50,points:5},{letter:'P',min:40,points:4},{letter:'F',min:0,points:0}],
  ghana:[{letter:'A',min:80,points:4.0},{letter:'B+',min:75,points:3.5},{letter:'B',min:70,points:3.0},{letter:'C+',min:65,points:2.5},{letter:'C',min:60,points:2.0},{letter:'D+',min:55,points:1.5},{letter:'D',min:50,points:1.0},{letter:'F',min:0,points:0}]
};
renderScaleList(scale);

function gradeFromScore(scale,score){
  const n=Number(score); if(!Number.isFinite(n)) return {letter:'—',points:0};
  const ranges=[...scale].sort((a,b)=>b.min-a.min);
  const band=ranges.find(r=>n>=r.min);
  return band?{letter:band.letter,points:band.points}:{letter:'—',points:0};
}

async function loadData(){
  const id=new URLSearchParams(location.search).get('id');
  if(id){
    try{
      const r=await fetch(`/api/submissions/${encodeURIComponent(id)}`);
      if(r.ok) return await r.json(); // { id, studentName, country, scaleLegend, courses:[] }
    }catch{}
  }
  const raw=sessionStorage.getItem('gpa_last_submission');
  if(!raw) return null;
  const j=JSON.parse(raw);
  return j.payload || null;
}
(async function(){
  const data=await loadData();
  if(!data){ document.body.insertAdjacentHTML('beforeend','<p>No data.</p>'); return; }
  document.getElementById('pStudent').textContent = data.studentName || '—';
  document.getElementById('pScale').textContent = data.scaleLegend || '';
  const scale=SCALES[data.country]||SCALES.nigeria;

  let units=0, quality=0;
  const tbody=document.getElementById('pBody');
  tbody.innerHTML='';
  (data.courses||[]).forEach(c=>{
    const {letter,points}=gradeFromScore(scale,c.score);
    units+=Number(c.unit)||0; quality+= (Number(c.unit)||0)*points;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${c.title||''}</td><td>${c.unit||0}</td><td>${c.score||0}</td><td>${letter}</td><td>${points}</td>`;
    tbody.appendChild(tr);
  });
  function renderScaleList(scale){
  const list = document.getElementById('pScaleList');
  if (!list) return;
  list.innerHTML = '';
  const ranges = [...scale].sort((a,b)=>b.min - a.min);
  ranges.forEach(r=>{
    const li = document.createElement('li');
    li.innerHTML = `
      <span class="badge">${r.letter}</span>
      <span>min ${r.min}</span>
      <span>${Number(r.points)} pts</span>
    `;
    list.appendChild(li);
  });
}
  document.getElementById('pUnits').textContent=units;
  document.getElementById('pGpa').textContent = units>0 ? (quality/units).toFixed(2) : '0.00';
})();
</script>
</body>
</html>
