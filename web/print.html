<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Results Sheet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./styles.css" />
  <style>
    @media print { .noprint{display:none} .scale-panel { break-inside: avoid; page-break-inside: avoid; } }
    /* Vertical scale block (same look as index) */
    .scale-panel{
      margin:16px 20px 24px;
      padding:12px;
      border-top:1px solid var(--muted);
      background:#0b1220;
      border-radius:12px;
    }
    .scale-title{
      margin:0 0 8px;
      font-size:16px;
      color:#cbd5e1;
    }
    .scale-list{
      list-style:none;
      margin:0;
      padding:0;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .scale-list li{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:8px 10px;
      border:1px solid var(--muted);
      border-radius:8px;
    }
    .scale-list .badge{ font-weight:600; }
    /* Hide the inline scale row so we only show the vertical block */
    #pScaleRow { display:none; }
  </style>
</head>
<body>
  <header>
    <h1>Results Sheet</h1>
    <button class="noprint" onclick="window.print()">Print</button>
  </header>

  <section class="stats">
    <div><strong>Student:</strong> <span id="pStudent">—</span></div>
    <div id="pScaleRow"><strong>Scale:</strong> <span id="pScale">—</span></div>
    <div><strong>Total Units:</strong> <span id="pUnits">0</span></div>
    <div><strong>GPA:</strong> <span id="pGpa">0.00</span></div>
  </section>

  <table class="grid">
    <thead>
      <tr>
        <th>Course</th><th>Units</th><th>Score</th><th>Grade</th><th>Points</th>
      </tr>
    </thead>
    <tbody id="pBody"></tbody>
  </table>

  <!-- Vertical grading scale AT THE BOTTOM -->
  <section class="scale-panel">
    <h2 class="scale-title">Grading scale</h2>
    <ul id="pScaleList" class="scale-list"></ul>
  </section>

<script>
/* ---------- Same scales as index ---------- */
const SCALES = {
  nigeria:[{letter:'A',min:70,points:5},{letter:'B',min:60,points:4},{letter:'C',min:50,points:3},{letter:'D',min:45,points:2},{letter:'E',min:40,points:1},{letter:'F',min:0,points:0}],
  us:[{letter:'A',min:90,points:4},{letter:'B',min:80,points:3},{letter:'C',min:70,points:2},{letter:'D',min:60,points:1},{letter:'F',min:0,points:0}],
  us_plusminus:[{letter:'A+',min:97,points:4.3},{letter:'A',min:93,points:4.0},{letter:'A-',min:90,points:3.7},{letter:'B+',min:87,points:3.3},{letter:'B',min:83,points:3.0},{letter:'B-',min:80,points:2.7},{letter:'C+',min:77,points:2.3},{letter:'C',min:73,points:2.0},{letter:'C-',min:70,points:1.7},{letter:'D',min:60,points:1.0},{letter:'F',min:0,points:0}],
  canada:[{letter:'A',min:85,points:4},{letter:'B',min:70,points:3},{letter:'C',min:60,points:2},{letter:'D',min:50,points:1},{letter:'F',min:0,points:0}],
  uk:[{letter:'First',min:70,points:4},{letter:'Upper Second',min:60,points:3},{letter:'Lower Second',min:50,points:2},{letter:'Third',min:40,points:1},{letter:'Fail',min:0,points:0}],
  australia:[{letter:'HD',min:85,points:7},{letter:'D',min:75,points:6},{letter:'C',min:65,points:5},{letter:'P',min:50,points:4},{letter:'N',min:0,points:0}],
  india:[{letter:'O',min:90,points:10},{letter:'A+',min:80,points:9},{letter:'A',min:70,points:8},{letter:'B+',min:60,points:7},{letter:'B',min:55,points:6},{letter:'C',min:50,points:5},{letter:'P',min:40,points:4},{letter:'F',min:0,points:0}],
  ghana:[{letter:'A',min:80,points:4.0},{letter:'B+',min:75,points:3.5},{letter:'B',min:70,points:3.0},{letter:'C+',min:65,points:2.5},{letter:'C',min:60,points:2.0},{letter:'D+',min:55,points:1.5},{letter:'D',min:50,points:1.0},{letter:'F',min:0,points:0}]
};

function gradeFromScore(scale, score){
  const n = Number(score);
  if (!Number.isFinite(n) || n<0 || n>100) return {letter:'—', points:0};
  const band = [...scale].sort((a,b)=>b.min-a.min).find(r => n >= r.min);
  return band ? {letter: band.letter, points: Number(band.points)} : {letter:'—', points:0};
}

function renderScaleList(scale){
  const list = document.getElementById('pScaleList');
  if (!list) return;
  list.innerHTML = '';
  const ranges = [...scale].sort((a,b)=>b.min - a.min);
  for (const r of ranges){
    const li = document.createElement('li');
    li.innerHTML = `
      <span class="badge">${r.letter}</span>
      <span>min ${r.min}</span>
      <span>${Number(r.points)} pts</span>
    `;
    list.appendChild(li);
  }
}

async function fetchSubmission(id){
  const res = await fetch(`/api/submissions/${encodeURIComponent(id)}`, { headers: { 'Accept': 'application/json' }});
  if (!res.ok) throw new Error(`GET /api/submissions/${id} → ${res.status}`);
  const text = await res.text();
  try { return JSON.parse(text); } catch { throw new Error('Server returned non-JSON'); }
}

async function loadData(){
  const id = new URLSearchParams(location.search).get('id');
  if (id) {
    try {
      const j = await fetchSubmission(id);
      // Normalize course keys if API returned Title/Unit/Score
      if (Array.isArray(j.courses) && j.courses.length && j.courses[0].Title) {
        j.courses = j.courses.map(r => ({ title: r.Title, unit: r.Unit, score: r.Score }));
      }
      return j;
    } catch (e) {
      console.warn('Fetch by id failed:', e);
      // fall through to sessionStorage
    }
  }
  const raw = sessionStorage.getItem('gpa_last_submission');
  if (!raw) return null;
  try {
    const j = JSON.parse(raw);
    return j.payload || null;
  } catch {
    return null;
  }
}

(async function(){
  const data = await loadData();
  console.log('Print data:', data);

  if (!data || !Array.isArray(data.courses) || data.courses.length === 0) {
    document.body.insertAdjacentHTML('beforeend', '<p style="padding:16px">No courses to print.</p>');
    return;
  }

  // Header stats
  document.getElementById('pStudent')?.replaceChildren(document.createTextNode(data.studentName || '—'));
  document.getElementById('pScale')?.replaceChildren(document.createTextNode(data.scaleLegend || ''));

  const scale = SCALES[data.country] || SCALES.nigeria;
  renderScaleList(scale);

  // Table rows
  const tbody = document.getElementById('pBody');
  tbody.innerHTML = '';
  let units = 0, quality = 0;

  for (const c of data.courses) {
    const unit = Number(c.unit) || 0;
    const score = Number(c.score) || 0;
    const { letter, points } = gradeFromScore(scale, score);
    units += unit; quality += unit * points;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${c.title || ''}</td>
      <td>${unit}</td>
      <td>${score}</td>
      <td>${letter}</td>
      <td>${points}</td>
    `;
    tbody.appendChild(tr);
  }

  document.getElementById('pUnits').textContent = String(units);
  document.getElementById('pGpa').textContent = units > 0 ? (quality / units).toFixed(2) : '0.00';
})();
</script>
</body>
</html>
